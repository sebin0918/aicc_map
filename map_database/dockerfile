# Base image로 MariaDB 11.3.2 사용
FROM mariadb:11.3.2

# 환경 변수 설정 (MariaDB 사용자와 비밀번호)
ENV MYSQL_ROOT_PASSWORD=root1234
ENV MYSQL_DATABASE=aicc_db_map

# 필요한 빌드 도구 및 Python 설치
RUN apt-get update && \
    apt-get install -y wget build-essential libssl-dev zlib1g-dev libncurses5-dev libncursesw5-dev libreadline-dev libsqlite3-dev libgdbm-dev libc6-dev libbz2-dev libffi-dev git && \
    wget https://www.python.org/ftp/python/3.11.9/Python-3.11.9.tgz && \
    tar xzf Python-3.11.9.tgz && \
    cd Python-3.11.9 && \
    ./configure --enable-optimizations && \
    make altinstall && \
    ln -s /usr/local/bin/python3.11 /usr/bin/python3 && \
    apt-get install -y python3-pip && \
    pip3 install --upgrade pip && \
    # 필요없는 빌드 도구 제거
    apt-get remove -y build-essential libssl-dev zlib1g-dev libncurses5-dev libncursesw5-dev libreadline-dev libsqlite3-dev libgdbm-dev libc6-dev libbz2-dev libffi-dev && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# 필요한 Python 라이브러리 설치
RUN pip3 install pymysql==1.1.1 \
    plotly==5.23.0 \
    pykrx==1.0.48 \
    yfinance==0.2.41 \
    fredapi==0.5.2 \
    tqdm  
# tqdm 추가

# GitHub에서 FinanceDataReader 소스 다운로드
RUN git clone https://github.com/FinanceData/FinanceDataReader.git /app/FinanceDataReader

# FinanceDataReader 모듈이 있는 경로를 PYTHONPATH에 추가
ENV PYTHONPATH="${PYTHONPATH}:/app/FinanceDataReader"

# 작업 디렉토리 설정
WORKDIR /app

# 모든 파일 복사 (map_database 디렉토리 안의 모든 파일을 /app으로 복사)
COPY . /app/


# 컨테이너 시작 시 DB_setting.py 파일을 한 번 실행하기 위한 entrypoint 설정
ENTRYPOINT ["bash", "-c", "python3 /app/DB_setting.py && exec mysqld"]
